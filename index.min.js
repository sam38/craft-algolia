/**
 * @author The Space In Between
 * @contact sam@thespaceinbetween.co.nz (Sudarshan Shakya)
 * @date 27th Feb 2019
 *
 * This JS-library will add the functionality of search and paginate
 * to the project with ease. The variables can all be configured as
 * per project requirement. This library is dependent on jQuery and
 * algolia library.
 */
var tsibSearch={init:function init(options){tsibSearch.data={algolia:{app:null,key:null,index:null,src:'https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js',urlPrefix:''},elements:{$form:null,$input:null,$more:null,$results:null,$status:null,$title:null},log:true,pagination:{perPage:10,showAll:false},result:{className:'searchResultsItem',blurbLength:220,blurbLengthWithImage:120,linkText:''},templates:{blankTitle:'Enter a \'keyword\' to search',blankStatus:'Enter a \'keyword\' to search',title:'We found {total} result{oneOrMany} for {keyword}.',titleEmpty:'We found no results for {keyword}',status:'Showing {displayed} of {total} result{oneOrMany}',statusEmpty:'No results found'},type:'default'};if(window.algoliasearch)tsibSearch.checkOptions(options);else{$.ajax({url:tsibSearch.data.algolia.src,dataType:'script',success:function(){tsibSearch.log('Algolia library fetch complete.');tsibSearch.checkOptions(options)},error:function(e){tsibSearch.log('Unable to fetch algolia library from '+tsibSearch.data.algolia.src+'!',e)}})}},log:function log(message1,message2){if(!tsibSearch.data.log)return;else if(message2)console.log(message1,message2);else console.log(message1)},checkOptions:function checkOptions(options){var data=tsibSearch.data;if(options===null||typeof options!=='object'){tsibSearch.log('tsibSearch requires Search configuration options `{}` as second parameter.');return}if(options.hasOwnProperty('elements'))$.extend(data.elements,options.elements);if(options.hasOwnProperty('pagination'))$.extend(data.pagination,options.pagination);if(options.hasOwnProperty('result'))$.extend(data.result,options.result);if(options.hasOwnProperty('templates'))$.extend(data.templates,options.templates);if(options.hasOwnProperty('log'))data.log=options.log;if(options.hasOwnProperty('type'))data.type=options.type;if(!data.elements.$form.length){tsibSearch.log('The form instance does not exist!');return}if(!data.elements.$form){tsibSearch.log('tsibSearch requires jQuery instance of your search form. e.g. { elements.$form = $(\'#searchFormId\') }');return}data.elements.$input=data.elements.$form.find('input[type="text"]:eq(0)');if(!data.elements.$input.length){tsibSearch.log('Search input not found inside the form!');return}var tempAttr=data.elements.$form.attr('data-url');if(typeof tempAttr!==typeof undefined&&tempAttr!==-1)data.algolia.urlPrefix=tempAttr;tempAttr=data.elements.$form.attr('data-app');if(typeof tempAttr!==typeof undefined&&tempAttr!==-1)data.algolia.app=tempAttr;tempAttr=data.elements.$form.attr('data-key');if(typeof tempAttr!==typeof undefined&&tempAttr!==-1)data.algolia.key=tempAttr;tempAttr=data.elements.$form.attr('data-index');if(typeof tempAttr!==typeof undefined&&tempAttr!==-1)data.algolia.index=tempAttr;if(!data.algolia.app||!data.algolia.key||!data.algolia.index){tsibSearch.log('Algolia hasn\'t been setup correctly! Please provide `app`, `key` and `index`');return}data.client=algoliasearch(data.algolia.app,data.algolia.key);data.index=data.client.initIndex(data.algolia.index);tsibSearch.bindEvents()},checkResultsPageMarkups:function checkResultsPageMarkups(){var data=tsibSearch.data;if(!data.elements.$title||!data.elements.$title.length){tsibSearch.log('Please provide options.$title e.g. $(\'#searchResultsTitleId\')');return false}if(!data.elements.$results||!data.elements.$results.length){tsibSearch.log('Please provide options.$results e.g. $(\'#searchResultsId\')');return false}if(!data.elements.$status||!data.elements.$status.length){tsibSearch.log('Please provide options.$status e.g. $(\'#searchStatusId\')');return false}if(!data.elements.$more||!data.elements.$more.length){tsibSearch.log('[Optional] More button is not configured. This is necessary to paginate your search results.')}return true},updateResultsTitle:function updateResultsTitle(content){var data=tsibSearch.data,title;if(typeof content==='string'){title=content===''?data.templates.blankTitle:data.templates.titleEmpty;title=title.replace('{keyword}',content)}else{title=data.templates.title;title=title.replace('{keyword}',content.query);title=title.replace('{oneOrMany}',(content.hits.length===1?'':'s'));title=title.replace('{total}',content.hits.length)}data.elements.$title.html(title)},bindEvents:function bindEvents(){var data=tsibSearch.data;tsibSearch.log(data);switch(data.type){case'ajax':data.elements.$form.on('submit',function(e){e.preventDefault();var val=data.elements.$input.val();if($.trim(val)===''){data.elements.$form.addClass('form-error')}else{data.elements.$form.removeClass('form-error');if(tsibSearch.checkResultsPageMarkups())tsibSearch.buildResults()}});break;case'hot':data.elements.$input.on('keyup',function(e){e.preventDefault();var val=data.elements.$input.val();if($.trim(val)===''){data.elements.$form.addClass('form-error');e.preventDefault()}else{data.elements.$form.removeClass('form-error');if(tsibSearch.checkResultsPageMarkups())tsibSearch.buildResults()}});data.elements.$form.on('submit',function(e){e.preventDefault()});break;default:if(tsibSearch.checkResultsPageMarkups())tsibSearch.buildResults();data.elements.$form.removeAttr('validate').attr('novalidate',true);data.elements.$form.on('submit',function(e){var val=data.elements.$input.val();if($.trim(val)===''){data.elements.$form.addClass('form-error');e.preventDefault()}else data.elements.$form.removeClass('form-error')});break}if(data.elements.$more&&data.elements.$more.length){data.elements.$more.on('click',function(e){e.preventDefault();var className=data.result.className;if(data.pagination.showAll){data.elements.$results.find('.'+className+'.hidden').removeClass('hidden').addClass(className+'Appear')}else{var total=0;data.elements.$results.find('.'+className+'.hidden').each(function(i,elm){if(++total<=data.pagination.perPage)$(elm).removeClass('hidden').addClass(className+'Appear')})}tsibSearch.buildResultStats()})}},buildResults:function bindResults(){var data=tsibSearch.data,keyword=data.elements.$input.val(),totalResults=0;if(keyword===''){tsibSearch.updateResultsTitle(keyword);data.elements.$status.html(data.templates.blankStatus)}else{data.index.search(data.elements.$input.val(),function(err,content){var result='';tsibSearch.updateResultsTitle(content);for(var i=0;i<content.hits.length;i++){totalResults++;result+=tsibSearch.buildSearchMarkup(content.hits[i],i)}data.elements.$results.html(result);tsibSearch.data.totalResults=content.hits.length;tsibSearch.buildResultStats();if(totalResults<=0)tsibSearch.updateResultsTitle(keyword)})}},buildResultStats:function buildResultStats(){var data=tsibSearch.data,hiddenItems=data.elements.$results.find('.'+data.result.className+'.hidden').length,totalItems=data.elements.$results.find('.'+data.result.className).length;var displayed=totalItems-hiddenItems;var title=data.templates.status,titleEmpty=data.templates.statusEmpty;title=title.replace('{displayed}',displayed);title=title.replace('{oneOrMany}',(data.totalResults===1?'':'s'));title=title.replace('{total}',data.totalResults);title=title.replace('{keyword}',data.elements.$input.val());tsibSearch.data.elements.$status.html(displayed<=0?titleEmpty:title);if(data.elements.$more&&data.elements.$more.length){if(hiddenItems>0)data.elements.$more.removeClass('hidden');else data.elements.$more.addClass('hidden')}},buildSearchMarkup:function buildSearchMarkup(row,i){var data=tsibSearch.data,dataSelector=data.result.className,itemImage=(row.image&&row.image!=='')?'<div class="'+dataSelector+'__image" style="background-image: url(\''+row.image+'\')"></div>':'';var description='';if(row._highlightResult.content){var content=row._highlightResult.content;content=content.constructor===Array?content[0].value:content.value;description=tsibSearch.searchDescription(content,row.image)}var hiddenClass=data.elements.$more&&i>=data.pagination.perPage?'hidden':'';var result='<a href="'+row.uri+'" class="'+dataSelector+' '+hiddenClass+'">';result+=itemImage+'<div class="'+dataSelector+'__content"><div class="'+dataSelector+'__title">'+row.title+'</div>';result+='<div class="'+dataSelector+'__description">'+description+data.result.linkText+'</div></div></a>';return result},searchDescription:function searchDescription(content,img){var limit=(img&&img!=='')?tsibSearch.data.result.blurbLengthWithImage:tsibSearch.data.result.blurbLength;return content.substr(0,limit)+(content.length>limit?'...':'')}};module.exports.tsibSearch=tsibSearch;